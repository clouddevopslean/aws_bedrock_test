# การเผยแพร่ API

## ภาพรวม

ตัวอย่างนี้มีคุณสมบัติสำหรับการเผยแพร่ API โดยอินเทอร์เฟซแชทอาจสะดวกสำหรับการตรวจสอบเบื้องต้น แต่การนำไปใช้งานจริงขึ้นอยู่กับกรณีการใช้งานเฉพาะและประสบการณ์ผู้ใช้ (UX) ที่ต้องการสำหรับผู้ใช้ปลายทาง ในบางสถานการณ์ UI แบบแชทอาจเป็นตัวเลือกที่ดีที่สุด ในขณะที่บางกรณีอาจเหมาะสมกับ API แบบสแตนด์อโลน หลังจากการตรวจสอบเบื้องต้น ตัวอย่างนี้มีความสามารถในการเผยแพร่บอทที่กำหนดเองตามความต้องการของโครงการ โดยการป้อนการตั้งค่าสำหรับโควตา การจำกัดความเร็ว แหล่งที่มา ฯลฯ จุดปลายทางสามารถเผยแพร่พร้อมกับคีย์ API ซึ่งให้ความยืดหยุ่นสำหรับตัวเลือกการรวมที่หลากหลาย

## ความปลอดภัย

การใช้เพียงคีย์ API เพียงอย่างเดียวไม่แนะนำ ตามที่อธิบายใน: [คู่มือนักพัฒนา AWS API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html) ดังนั้น ตัวอย่างนี้จึงใช้การจำกัดที่อยู่ IP อย่างง่ายผ่าน AWS WAF กฎ WAF จะถูกนำไปใช้ร่วมกันทั่วทั้งแอปพลิเคชันเนื่องจากข้อพิจารณาด้านต้นทุน โดยอยู่ภายใต้ข้อสันนิษฐานว่าแหล่งที่มาที่ต้องการจำกัดน่าจะเป็นแบบเดียวกันในทุก API ที่ออก **โปรดปฏิบัตติามนโยบายความปลอดภัยขององค์กรสำหรับการนำไปใช้งานจริง** นอกจากนี้ โปรดดูส่วน[สถาปัตยกรรม](#architecture)

## วิธีเผยแพร่ Bot API แบบกำหนดเอง

### ข้อกำหนดเบื้องต้น

ด้วยเหตุผลทางการกำกับดูแล เฉพาะผู้ใช้งานที่จำกัดเท่านั้นที่สามารถเผยแพร่บอทได้ ก่อนการเผยแพร่ ผู้ใช้ต้องเป็นสมาชิกของกลุ่มที่เรียกว่า `PublishAllowed` ซึ่งสามารถตั้งค่าได้ผ่านคอนโซลการจัดการ > Amazon Cognito User pools หรือ aws cli โปรดทราบว่าไอดีของกลุ่มผู้ใช้สามารถอ้างอิงได้โดยเข้าถึง CloudFormation > BedrockChatStack > Outputs > `AuthUserPoolIdxxxx`

![](./imgs/group_membership_publish_allowed.png)

### การตั้งค่าการเผยแพร่ API

หลังจากเข้าสู่ระบบในฐานะผู้ใช้ `PublishedAllowed` และสร้างบอท ให้เลือก `API PublishSettings` โปรดทราบว่าสามารถเผยแพร่เฉพาะบอทที่ใช้ร่วมกันได้
![](./imgs/bot_api_publish_screenshot.png)

บนหน้าจอถัดไป คุณสามารถกำหนดค่าพารามิเตอร์ต่าง ๆ เกี่ยวกับการควบคุมอัตราการร้องขอ สำหรับรายละเอียดเพิ่มเติม โปรดดูที่: [ควบคุมคำขอ API เพื่อเพิ่มประสิทธิภาพการส่งผ่าน](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html)
![](./imgs/bot_api_publish_screenshot2.png)

หลังการปรับใช้ หน้าจอต่อไปนี้จะปรากฏขึ้น ที่ซึ่งคุณสามารถรับ URL ปลายทางและคีย์ API เราสามารถเพิ่มและลบคีย์ API ได้

![](./imgs/bot_api_publish_screenshot3.png)

## สถาปัตยกรรม

API ถูกเผยแพร่ตามแผนภาพต่อไปนี้:

![](./imgs/published_arch.png)

WAF ใช้สำหรับการจำกัดที่อยู่ IP โดยสามารถกำหนดค่าได้ด้วยการตั้งพารามิเตอร์ `publishedApiAllowedIpV4AddressRanges` และ `publishedApiAllowedIpV6AddressRanges` ใน `cdk.json`

เมื่อผู้ใช้คลิกเผยแพร่บอท [AWS CodeBuild](https://aws.amazon.com/codebuild/) จะเริ่มงานปรับใช้ CDK เพื่อจัดเตรียมสแต็ก API (ดูเพิ่มเติมที่: [คำนิยาม CDK](../cdk/lib/api-publishment-stack.ts)) ซึ่งประกอบด้วย API Gateway, Lambda และ SQS SQS ใช้เพื่อแยกคำขอของผู้ใช้และการดำเนินการ LLM เนื่องจากการสร้างผลลัพธ์อาจใช้เวลาเกิน 30 วินาที ซึ่งเป็นขีดจำกัดของโควตา API Gateway ในการเข้าถึงผลลัพธ์ จำเป็นต้องเข้าถึง API แบบอะซิงโครนัส สำหรับรายละเอียดเพิ่มเติม ดู [ข้อกำหนด API](#api-specification)

ไคลเอนต์ต้องตั้งค่า `x-api-key` ในส่วนหัวของคำขอ

## ข้อกำหนด API

ดูได้ที่[ที่นี่](https://aws-samples.github.io/bedrock-claude-chat)